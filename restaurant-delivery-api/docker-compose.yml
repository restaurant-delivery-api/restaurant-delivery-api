version: '3'

services:

  app-database:
    image: "postgres:16-alpine"
    container_name: postgres-app
    restart: always

    environment:
      # новопточники сказали как-то по другому передавать пароль
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: restaurant-delivery
      PGDATA: /var/lib/postgresql/data/pgdata/app
      PGPORT: 5433

    ports:
      - "5433:5433"

  sonar-database:
    image: "postgres:16-alpine"
    container_name: postgres-sonar
    restart: always

    environment:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
      POSTGRES_DB: sonar
      PGDATA: /var/lib/postgresql/data/pgdata/sonar
      PGPORT: 5434

    ports:
      - "5434:5434"

  sonarqube:
    image: "sonarqube:community"
    container_name: sonarqube
    restart: always

    environment:
      SONAR_JDBC_URL: jdbc:postgresql://sonar-database:5434/sonar
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar

    ports:
      - "9000:9000"
    depends_on:
      - sonar-database

  app:
    container_name: restaurant-delivery
    restart: always

    build:
      context: ./
      dockerfile: Dockerfile

    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://app-database:5433/restaurant-delivery

    ports:
      - "8080:8080"
    depends_on:
      - app-database
